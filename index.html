<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>LAZARO WORLD — Simple City</title>
<style>
  html,body{margin:0;height:100%;overflow:hidden;background:#0b0f1e;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  canvas{width:100vw;height:100vh;display:block;touch-action:none}
  .ui{position:fixed;inset:0;pointer-events:none;color:#fff}
  .top{position:fixed;left:12px;right:12px;top:12px;padding:10px 12px;border-radius:16px;
    background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(10px);
    font-weight:900;letter-spacing:.6px}
  .hud{position:fixed;left:12px;bottom:12px;max-width:min(820px,82vw);padding:10px 12px;border-radius:16px;
    background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(10px);
    font-size:12px;line-height:1.35}

  /* Mobile controls */
  #joy{pointer-events:auto;position:fixed;left:14px;bottom:150px;width:150px;height:150px;border-radius:999px;
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(8px)}
  #knob{position:absolute;left:50%;top:50%;width:64px;height:64px;transform:translate(-50%,-50%);
    border-radius:999px;background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18)}
  .mBtn{pointer-events:auto;position:fixed;right:14px;border-radius:18px;padding:14px 16px;
    border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);color:#fff;font-weight:950}
  .mBtn:active{transform:scale(.98)}
  #action{bottom:18px}
  #brake{bottom:86px}
  @media (pointer:fine){#joy,.mBtn{display:none}}
</style>
</head>
<body>
<canvas id="c"></canvas>

<div class="ui">
  <div class="top" id="top">LAZARO WORLD — Simple City ✅</div>
  <div class="hud" id="hud"></div>
  <div id="joy"><div id="knob"></div></div>
  <div class="mBtn" id="brake">BRAKE</div>
  <div class="mBtn" id="action">ACTION</div>
</div>

<script>
(() => {
  const c = document.getElementById("c");
  const ctx = c.getContext("2d", {alpha:false});
  const hud = document.getElementById("hud");

  function resize(){
    const dpr = Math.max(1, Math.min(2, devicePixelRatio||1));
    c.width = (innerWidth*dpr)|0;
    c.height = (innerHeight*dpr)|0;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener("resize", resize); resize();

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const rand=(a,b)=>a+Math.random()*(b-a);

  // ===== World tiles (no PNG, just colors) =====
  const TILE = 24;
  const MAP_W = 120, MAP_H = 90;
  const WORLD_W = MAP_W*TILE, WORLD_H = MAP_H*TILE;
  const map = new Uint8Array(MAP_W*MAP_H);
  const idx=(x,y)=>y*MAP_W+x;
  const inb=(x,y)=>x>=0&&y>=0&&x<MAP_W&&y<MAP_H;

  // 0 ground, 1 road, 2 park, 3 water, 4 building (solid)
  function gen(){
    map.fill(0);

    // water strip
    for(let y=0;y<MAP_H;y++){
      for(let x=MAP_W-20;x<MAP_W;x++) map[idx(x,y)] = 3;
    }

    // roads
    for(let y=0;y<MAP_H;y++){
      for(let x=0;x<MAP_W-20;x++){
        if(x%10===0 || y%10===0) map[idx(x,y)] = 1;
      }
    }

    // parks
    for(let i=0;i<500;i++){
      const x=(Math.random()*(MAP_W-26)|0)+2;
      const y=(Math.random()*(MAP_H-4)|0)+2;
      if(map[idx(x,y)]===0) map[idx(x,y)] = 2;
    }

    // buildings
    for(let i=0;i<1000;i++){
      const bx=(Math.random()*(MAP_W-26)|0)+2;
      const by=(Math.random()*(MAP_H-6)|0)+2;
      const w=(2+Math.random()*6|0), h=(2+Math.random()*6|0);

      let ok=true;
      for(let y=by;y<by+h;y++){
        for(let x=bx;x<bx+w;x++){
          if(!inb(x,y) || map[idx(x,y)]!==0) ok=false;
        }
      }
      if(!ok) continue;
      for(let y=by;y<by+h;y++){
        for(let x=bx;x<bx+w;x++) map[idx(x,y)] = 4;
      }
    }
  }
  gen();

  function tileAt(px,py){
    const tx=(px/TILE)|0, ty=(py/TILE)|0;
    if(!inb(tx,ty)) return 4;
    return map[idx(tx,ty)];
  }
  function solidAt(px,py){
    const t=tileAt(px,py);
    return t===4 || t===3;
  }

  // ===== Input =====
  const keys=new Set();
  addEventListener("keydown", e=>{
    const k=e.key.toLowerCase();
    keys.add(k);
    if(k==="e") action();
    if(k==="g") gen();
  });
  addEventListener("keyup", e=>keys.delete(e.key.toLowerCase()));

  // Mobile joystick
  const joy=document.getElementById("joy");
  const knob=document.getElementById("knob");
  let joyState={id:null,active:false,dx:0,dy:0};
  function setKnob(dx,dy){
    const max=46;
    knob.style.transform=`translate(calc(-50% + ${dx*max}px), calc(-50% + ${dy*max}px))`;
  }
  function joyRect(){ return joy.getBoundingClientRect(); }
  joy.addEventListener("pointerdown", e=>{ joyState.id=e.pointerId; joyState.active=true; joy.setPointerCapture(e.pointerId); });
  joy.addEventListener("pointermove", e=>{
    if(!joyState.active||e.pointerId!==joyState.id) return;
    const r=joyRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
    const vx=e.clientX-cx, vy=e.clientY-cy;
    const max=r.width/2-10;
    joyState.dx=clamp(vx/max,-1,1); joyState.dy=clamp(vy/max,-1,1);
    setKnob(joyState.dx, joyState.dy);
  });
  function joyReset(){ joyState.active=false; joyState.id=null; joyState.dx=0; joyState.dy=0; setKnob(0,0); }
  joy.addEventListener("pointerup", e=>{ if(e.pointerId===joyState.id) joyReset(); });
  joy.addEventListener("pointercancel", joyReset);

  document.getElementById("action").addEventListener("click", ()=>action());
  let handbrake=false;
  document.getElementById("brake").addEventListener("pointerdown", ()=>handbrake=true);
  document.getElementById("brake").addEventListener("pointerup", ()=>handbrake=false);
  document.getElementById("brake").addEventListener("pointercancel", ()=>handbrake=false);

  // ===== Entities =====
  const player={x:260,y:260,r:8,inCar:false};
  const cars=[];
  function spawnCar(x,y){ cars.push({x,y,a:0,spd:0,driver:false}); }
  for(let i=0;i<12;i++) spawnCar(rand(140,WORLD_W-360), rand(140,WORLD_H-140));

  function nearestCar(){
    let best=null, bd=1e9;
    for(const car of cars){
      const d=Math.hypot(car.x-player.x, car.y-player.y);
      if(d<bd){ bd=d; best=car; }
    }
    return {car:best,dist:bd};
  }

  function action(){
    const {car,dist}=nearestCar();
    if(!player.inCar){
      if(car && dist<30){ player.inCar=true; car.driver=true; }
    }else{
      const c=cars.find(v=>v.driver);
      if(c){ c.driver=false; player.inCar=false; player.x=c.x+30; player.y=c.y; }
    }
  }

  function collidesCircle(x,y,r){
    const pts=[[x+r,y],[x-r,y],[x,y+r],[x,y-r]];
    for(const [px,py] of pts){
      if(solidAt(px,py)) return true;
    }
    return false;
  }
  function moveWithCollide(obj,dx,dy,r){
    let nx=obj.x+dx, ny=obj.y;
    if(!collidesCircle(nx,ny,r)) obj.x=nx;
    nx=obj.x; ny=obj.y+dy;
    if(!collidesCircle(nx,ny,r)) obj.y=ny;
  }

  const cam={x:0,y:0};
  function updateCam(){
    cam.x=clamp(player.x-innerWidth/2,0,Math.max(0,WORLD_W-innerWidth));
    cam.y=clamp(player.y-innerHeight/2,0,Math.max(0,WORLD_H-innerHeight));
  }

  // ===== Loop =====
  let last=performance.now();
  function tick(now){
    const dt=Math.min(0.033,(now-last)/1000);
    last=now;
    update(dt);
    render();
    requestAnimationFrame(tick);
  }

  function update(dt){
    let mx=0,my=0;
    if(keys.has("w")||keys.has("arrowup")) my-=1;
    if(keys.has("s")||keys.has("arrowdown")) my+=1;
    if(keys.has("a")||keys.has("arrowleft")) mx-=1;
    if(keys.has("d")||keys.has("arrowright")) mx+=1;
    mx+=joyState.dx; my+=joyState.dy;
    const m=Math.hypot(mx,my);
    if(m>1e-6){ mx/=m; my/=m; }

    if(player.inCar){
      const car=cars.find(c=>c.driver);
      if(car){
        car.spd += (handbrake?120:520)*dt;
        car.spd *= handbrake ? (1-7*dt) : (1-2.4*dt);
        car.spd = Math.min(car.spd, handbrake?160:300);

        if(Math.abs(mx)+Math.abs(my)>0.05){
          const target=Math.atan2(my,mx);
          let da=target-car.a;
          while(da>Math.PI) da-=Math.PI*2;
          while(da<-Math.PI) da+=Math.PI*2;
          car.a += clamp(da,-3.4*dt,3.4*dt);
        }
        moveWithCollide(car, Math.cos(car.a)*car.spd*dt, Math.sin(car.a)*car.spd*dt, 10);
        player.x=car.x; player.y=car.y;
      }
    }else{
      moveWithCollide(player, mx*170*dt, my*170*dt, player.r);
    }
    updateCam();
  }

  function render(){
    ctx.fillStyle="#0b0f1e";
    ctx.fillRect(0,0,innerWidth,innerHeight);

    ctx.save();
    ctx.translate(-cam.x,-cam.y);

    const x0=Math.max(0,((cam.x)/TILE|0)-2);
    const y0=Math.max(0,((cam.y)/TILE|0)-2);
    const x1=Math.min(MAP_W-1,((cam.x+innerWidth)/TILE|0)+2);
    const y1=Math.min(MAP_H-1,((cam.y+innerHeight)/TILE|0)+2);

    // tiles
    for(let ty=y0;ty<=y1;ty++){
      for(let tx=x0;tx<=x1;tx++){
        const t=map[idx(tx,ty)];
        if(t===0){ ctx.fillStyle="#2b2f40"; }      // ground
        else if(t===1){ ctx.fillStyle="#121624"; } // road
        else if(t===2){ ctx.fillStyle="#1f3b2b"; } // park
        else if(t===3){ ctx.fillStyle="#103a58"; } // water
        else { ctx.fillStyle="#3b3f52"; }          // building base
        ctx.fillRect(tx*TILE, ty*TILE, TILE, TILE);

        // road stripes
        if(t===1){
          ctx.fillStyle="rgba(255,255,255,0.08)";
          ctx.fillRect(tx*TILE+TILE/2-1, ty*TILE+2, 2, TILE-4);
        }

        // buildings add "height"
        if(t===4){
          ctx.fillStyle="rgba(0,0,0,0.25)";
          ctx.fillRect(tx*TILE, ty*TILE, TILE, TILE);
          ctx.fillStyle="rgba(255,255,255,0.06)";
          ctx.fillRect(tx*TILE, ty*TILE, TILE, 4);
          ctx.fillRect(tx*TILE, ty*TILE, 4, TILE);
        }
      }
    }

    // cars (simple)
    for(const car of cars){
      ctx.save();
      ctx.translate(car.x,car.y);
      ctx.rotate(car.a + Math.PI/2);
      ctx.fillStyle="rgba(0,0,0,0.25)";
      ctx.fillRect(-14+2,-8+5,28,16);
      ctx.fillStyle="#d13b3b";
      ctx.fillRect(-14,-8,28,16);
      ctx.fillStyle="rgba(255,255,255,0.12)";
      ctx.fillRect(-10,-6,20,4);
      if(car.driver){
        ctx.fillStyle="#3cffcc";
        ctx.fillRect(-2,-2,4,4);
      }
      ctx.restore();
    }

    // player
    ctx.save();
    ctx.translate(player.x,player.y);
    ctx.fillStyle="rgba(0,0,0,0.25)";
    ctx.beginPath(); ctx.arc(0,10,7,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#3cffcc"; ctx.fillRect(-6,-8,12,16);
    ctx.fillStyle="#ffd6a5"; ctx.fillRect(-5,-16,10,7);
    ctx.restore();

    ctx.restore();

    hud.innerHTML =
      `<b>Controls:</b> WASD/Arrows move • E/ACTION enter/exit car • G = new city<br>`+
      `<b>Note:</b> This version uses NO PNG tiles, so it will never show the tilesheet.`;
  }

  requestAnimationFrame(tick);
})();
</script>
</body>
</html>
